import streamlit as st
import pandas as pd

def calculate_egfr(age, creatinine, sex):
    if sex == 'å¥³æ€§':
        k = 0.7
        a = -0.329
        gender_factor = 1.018
    else:
        k = 0.9
        a = -0.411
        gender_factor = 1
    egfr = 141 * min(creatinine / k, 1) ** a * max(creatinine / k, 1) ** -1.209 * 0.993 ** age * gender_factor
    return egfr

def main():
    st.set_page_config(page_title="è…åŠŸèƒ½è©•ä¼°èˆ‡è¡›æ•™å»ºè­°", page_icon="ğŸ©º")
    st.title("ğŸ©º ä¸€èˆ¬å¥åº·åƒæ•¸è©•ä¼°èˆ‡è¡°å¼±é¢¨éšª")

    st.markdown("""
    æ­¤å·¥å…·å¯å”åŠ©æ‚¨æ ¹æ“šå¹´é½¡ã€æ€§åˆ¥ã€è‚Œé…æ•¸å€¼ã€è‡ªå¡«è¡€å£“èˆ‡èº«é«˜é«”é‡ï¼Œé ä¼°è…åŠŸèƒ½ (eGFR)ï¼Œ
    ä¸¦æä¾›è¡€å£“ã€é«”é‡ã€è…åŠŸèƒ½åŠè¡°å¼±é¢¨éšªçš„å€‹åˆ¥è¡›æ•™å»ºè­°ã€‚
    """)

    with st.form("health_form"):
        st.header("ğŸ”¢ è«‹è¼¸å…¥æ‚¨çš„åŸºæœ¬è³‡æ–™")
        col1, col2 = st.columns(2)
        with col1:
            age = st.number_input("å¹´é½¡ (æ­²)", min_value=1, max_value=120, value=65)
            sex = st.selectbox("ç”Ÿç†æ€§åˆ¥", ["å¥³æ€§", "ç”·æ€§"])
            height = st.number_input("èº«é«˜ (å…¬åˆ†)", min_value=100.0, max_value=250.0, value=165.0)
        with col2:
            creatinine = st.number_input("è‚Œé…å€¼ (mg/dL)", min_value=0.1, max_value=15.0, value=1.0)
            sbp = st.number_input("æ”¶ç¸®å£“ SBP (mmHg)", min_value=80, max_value=250, value=130)
            dbp = st.number_input("èˆ’å¼µå£“ DBP (mmHg)", min_value=40, max_value=150, value=85)
            weight = st.number_input("é«”é‡ (å…¬æ–¤)", min_value=30.0, max_value=200.0, value=70.0)

        st.header("ğŸ’¬ è¡°å¼±é‡è¡¨ï¼ˆè«‹å¦‚å¯¦å¡«å¯«ï¼‰")
        frailty_items = {
            "æ˜¯å¦åœ¨éå»ä¸€å¹´å…§é«”é‡ç„¡æ„æ¸›å°‘è¶…é 5 å…¬æ–¤ï¼Ÿ": st.checkbox("1ï¸âƒ£ é«”é‡æ˜¯å¦åœ¨ä¸€å¹´å…§ç„¡æ•…æ¸›è¼•è¶…é 5 å…¬æ–¤"),
            "æ˜¯å¦è¦ºå¾—è‡ªå·±å®¹æ˜“ç–²æ†Šï¼Ÿ": st.checkbox("2ï¸âƒ£ æ˜¯å¦å¸¸è¦ºå¾—ç–²æ†Šæˆ–ç„¡åŠ›"),
            "ä¸€é€±å…§æ˜¯å¦å¾äº‹ä½æ–¼ 3 æ¬¡é‹å‹•ï¼Ÿ": st.checkbox("3ï¸âƒ£ æ˜¯å¦æ¯é€±é‹å‹•æ¬¡æ•¸å°‘æ–¼ 3 æ¬¡"),
            "æ˜¯å¦èµ°è·¯è®Šæ…¢ï¼Œç„¡æ³•å¿«é€Ÿè¡Œèµ°ï¼Ÿ": st.checkbox("4ï¸âƒ£ æ˜¯å¦èµ°è·¯é€Ÿåº¦è®Šæ…¢"),
            "æ˜¯å¦è¦ºå¾—æ¡åŠ›è®Šå¼±æˆ–æé‡ç‰©å›°é›£ï¼Ÿ": st.checkbox("5ï¸âƒ£ æ˜¯å¦æ¡åŠ›ä¸‹é™æˆ–æé‡ç‰©å›°é›£"),
        }

        submitted = st.form_submit_button("é€å‡ºè©•ä¼°")

    if submitted:
        bmi = weight / (height / 100) ** 2
        egfr = calculate_egfr(age, creatinine, sex)
        frailty_score = sum(frailty_items.values())

        st.header("ğŸ“Š è©•ä¼°çµæœ")
        st.metric("eGFR (ml/min/1.73mÂ²)", f"{egfr:.1f}")
        st.metric("BMI (kg/mÂ²)", f"{bmi:.1f}")

        st.subheader("ğŸ’¡ è¡›æ•™å»ºè­°")

        # è¡€å£“åˆ†æ
        if sbp < 90 or dbp < 60:
            st.warning("è¡€å£“åä½")
            st.write("å¯èƒ½å°è‡´é ­æšˆã€è·Œå€’é¢¨éšªï¼Œå»ºè­°å¢åŠ æ°´åˆ†èˆ‡é¹½åˆ†æ”å–ï¼Œé¿å…çªç„¶èµ·èº«ï¼Œå¿…è¦æ™‚å°±é†«è©•ä¼°æ˜¯å¦éœ€è—¥ç‰©èª¿æ•´ã€‚")
        elif sbp >= 140 or dbp >= 90:
            st.warning("è¡€å£“åé«˜")
            st.write("å»ºè­°æ¸›å°‘éˆ‰æ”å–ï¼ˆå¦‚å°‘åƒåŠ å·¥é£Ÿå“ï¼‰ã€å¢åŠ è¦å¾‹æœ‰æ°§é‹å‹•ã€æ§åˆ¶å£“åŠ›ï¼Œä¸¦ä¾éœ€è¦å®šæœŸé‡æ¸¬è¡€å£“ã€‚")
        else:
            st.info("è¡€å£“æ­£å¸¸")
            st.write("è«‹æŒçºŒä¿æŒå¥åº·ç”Ÿæ´»ç¿’æ…£ï¼Œä¾‹å¦‚ï¼šå‡è¡¡é£²é£Ÿã€é¿å…éé¹¹é£Ÿç‰©ã€è¦å¾‹é‹å‹•èˆ‡é©ç•¶ä½œæ¯ï¼Œä»¥ç¶­æŒæ­£å¸¸è¡€å£“ã€‚")

        # é«”é‡ï¼ˆBMIï¼‰åˆ†æ
        if bmi < 18.5:
            st.warning(f"é«”é‡éè¼•ï¼ˆBMIï¼š{bmi:.1f}ï¼‰")
            st.write("å»ºè­°å¢åŠ ç†±é‡èˆ‡è›‹ç™½è³ªæ”å–ï¼Œå¦‚ç‰›å¥¶ã€è±†è£½å“ã€å …æœç­‰ï¼Œä¸¦å¯æ­é…é˜»åŠ›è¨“ç·´æå‡è‚Œè‚‰é‡ã€‚")
        elif bmi >= 27:
            st.warning(f"é«”é‡éé‡ï¼ˆBMIï¼š{bmi:.1f}ï¼‰")
            st.write("å»ºè­°æ¡å–ä½æ²¹ã€ä½ç³–ã€é«˜çº–é£²é£Ÿï¼Œå¢åŠ èº«é«”æ´»å‹•ï¼Œè¨­å®šå¥åº·æ¸›é‡ç›®æ¨™ï¼Œæ¯é€±æ¸›å°‘0.5ï½1å…¬æ–¤ç‚ºå®œã€‚")
        else:
            st.info(f"é«”é‡æ­£å¸¸ï¼ˆBMIï¼š{bmi:.1f}ï¼‰")
            st.write("è«‹ç¶­æŒç›®å‰çš„é£²é£Ÿèˆ‡é‹å‹•ç¿’æ…£ï¼Œä¸¦é¿å…ä¹…åèˆ‡é«˜ç†±é‡é£Ÿç‰©æ”å–ã€‚")

        # eGFRåˆ†æ
        if egfr < 60:
            st.error(f"è…åŠŸèƒ½ä¸‹é™ï¼ˆeGFRï¼š{egfr:.1f} ml/min/1.73mÂ²ï¼‰")
            st.write("å»ºè­°æ¸›å°‘è›‹ç™½è³ªæ”å–ã€æ§åˆ¶é«˜è¡€å£“ã€é™åˆ¶éˆ‰èˆ‡ç£·æ”å–ï¼Œä¸¦å®šæœŸè¿½è¹¤è…åŠŸèƒ½ã€‚å¿…è¦æ™‚è½‰ä»‹è…è‡Ÿå°ˆç§‘ã€‚")
        else:
            st.info(f"è…åŠŸèƒ½æ­£å¸¸ï¼ˆeGFRï¼š{egfr:.1f} ml/min/1.73mÂ²ï¼‰")
            st.write("è«‹æŒçºŒä¿æŒé£²æ°´ç¿’æ…£ã€æ§åˆ¶è¡€å£“èˆ‡è¡€ç³–ã€é¿å…éåº¦æ”å–è›‹ç™½è³ªèˆ‡æ­¢ç—›è—¥ï¼Œä»¥é é˜²è…åŠŸèƒ½æƒ¡åŒ–ã€‚")

        # è¡°å¼±é‡è¡¨çµæœ
        st.subheader("ğŸ§“ è¡°å¼±é¢¨éšªåˆ†æ")
        if frailty_score == 0:
            st.success("æ‚¨ç›®å‰ç„¡è¡°å¼±å¾µè±¡")
            st.write("è«‹æŒçºŒè¦å¾‹é‹å‹•ã€å‡è¡¡é£²é£Ÿã€èˆ‡ç¶­æŒç¤¾æœƒåƒèˆ‡ï¼Œä»¥é é˜²è¡°å¼±ã€‚")
        elif frailty_score <= 2:
            st.warning(f"æ‚¨å¯èƒ½è™•æ–¼ã€Œå‰è¡°å¼±ã€ç‹€æ…‹ï¼ˆåˆ†æ•¸ï¼š{frailty_score}ï¼‰")
            st.write("å»ºè­°å¢åŠ èº«é«”æ´»å‹•ã€æ³¨æ„ç‡Ÿé¤Šæ”å–ã€ä¸¦å®šæœŸè©•ä¼°èº«é«”åŠŸèƒ½ã€‚")
        else:
            st.error(f"æœ‰æ˜é¡¯è¡°å¼±å¾µè±¡ï¼ˆåˆ†æ•¸ï¼š{frailty_score}ï¼‰")
            st.write("å»ºè­°å°±é†«è©•ä¼°ã€è¦åŠƒç‡Ÿé¤Šèˆ‡é‹å‹•ä»‹å…¥æ–¹æ¡ˆï¼Œä¸¦æ³¨æ„è·Œå€’èˆ‡å¤±èƒ½é¢¨éšªã€‚")

        # å€‹åˆ¥è¡°å¼±é …ç›®è¡›æ•™
        st.subheader("ğŸ“Œ å„é …è¡°å¼±å¾µè±¡èˆ‡å»ºè­°")

        if frailty_items["æ˜¯å¦åœ¨éå»ä¸€å¹´å…§é«”é‡ç„¡æ„æ¸›å°‘è¶…é 5 å…¬æ–¤ï¼Ÿ"]:
            st.warning("â— é«”é‡æœ‰æ˜é¡¯æ¸›è¼•")
            st.write("å»ºè­°å¢åŠ è›‹ç™½è³ªèˆ‡ç†±é‡æ”å–ï¼Œä¸¦è«®è©¢ç‡Ÿé¤Šå¸«ï¼Œæ’é™¤æ½›åœ¨ç–¾ç—…å¦‚ç™Œç—‡æˆ–è…¸èƒƒå•é¡Œã€‚")

        if frailty_items["æ˜¯å¦è¦ºå¾—è‡ªå·±å®¹æ˜“ç–²æ†Šï¼Ÿ"]:
            st.warning("â— ç¶“å¸¸æ„Ÿåˆ°ç–²æ†Š")
            st.write("å¯èƒ½èˆ‡ç¡çœ å“è³ªã€ç‡Ÿé¤Šæˆ–å¿ƒç†å£“åŠ›ç›¸é—œã€‚å»ºè­°æ”¹å–„ä½œæ¯ã€å‡è¡¡é£²é£Ÿï¼Œå¿…è¦æ™‚å¿ƒç†è«®è©¢ã€‚")

        if frailty_items["ä¸€é€±å…§æ˜¯å¦å¾äº‹ä½æ–¼ 3 æ¬¡é‹å‹•ï¼Ÿ"]:
            st.warning("â— æ´»å‹•é‡ä¸è¶³")
            st.write("å»ºè­°æ¯é€±é€²è¡Œè‡³å°‘ 150 åˆ†é˜ä¸­ç­‰å¼·åº¦é‹å‹•ï¼Œå¦‚å¿«èµ°ã€æœ‰æ°§æ“ã€å¤ªæ¥µç­‰ã€‚")

        if frailty_items["æ˜¯å¦èµ°è·¯è®Šæ…¢ï¼Œç„¡æ³•å¿«é€Ÿè¡Œèµ°ï¼Ÿ"]:
            st.warning("â— è¡Œèµ°è®Šæ…¢")
            st.write("å¯é€éè‚ŒåŠ›èˆ‡å¹³è¡¡è¨“ç·´æå‡æ­¥æ…‹ç©©å®šæ€§ï¼Œé é˜²è·Œå€’ï¼Œä¾‹å¦‚é€²è¡Œè…¿éƒ¨é˜»åŠ›è¨“ç·´ã€‚")

        if frailty_items["æ˜¯å¦è¦ºå¾—æ¡åŠ›è®Šå¼±æˆ–æé‡ç‰©å›°é›£ï¼Ÿ"]:
            st.warning("â— æ¡åŠ›ä¸‹é™")
            st.write("å»ºè­°ä½¿ç”¨å½ˆåŠ›çƒã€é‡é‡è¨“ç·´æˆ–æ—¥å¸¸æç‰©ç­‰æ–¹å¼è¨“ç·´å‰è‡‚èˆ‡æ‰‹éƒ¨è‚Œè‚‰ã€‚")

if __name__ == '__main__':
    main()
